<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Spatial Processing Pipeline · Emissions.jl</title><meta name="title" content="Spatial Processing Pipeline · Emissions.jl"/><meta property="og:title" content="Spatial Processing Pipeline · Emissions.jl"/><meta property="twitter:title" content="Spatial Processing Pipeline · Emissions.jl"/><meta name="description" content="Documentation for Emissions.jl."/><meta property="og:description" content="Documentation for Emissions.jl."/><meta property="twitter:description" content="Documentation for Emissions.jl."/><meta property="og:url" content="https://emissions.earthsci.dev/spatial_processing/"/><meta property="twitter:url" content="https://emissions.earthsci.dev/spatial_processing/"/><link rel="canonical" href="https://emissions.earthsci.dev/spatial_processing/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Emissions.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../tutorial/">Complete Tutorial</a></li><li><a class="tocitem" href="../nei_processing/">NEI Processing</a></li><li class="is-active"><a class="tocitem" href>Spatial Processing Pipeline</a><ul class="internal"><li><a class="tocitem" href="#Overview"><span>Overview</span></a></li><li><a class="tocitem" href="#Data-Preparation-Functions"><span>Data Preparation Functions</span></a></li><li><a class="tocitem" href="#Spatial-Allocation-Functions"><span>Spatial Allocation Functions</span></a></li><li><a class="tocitem" href="#Implementation"><span>Implementation</span></a></li><li><a class="tocitem" href="#Analysis"><span>Analysis</span></a></li><li><a class="tocitem" href="#Relationship-to-Reference-Workflow"><span>Relationship to Reference Workflow</span></a></li></ul></li><li><a class="tocitem" href="../temporal_processing/">Temporal Processing</a></li><li><a class="tocitem" href="../speciation/">Chemical Speciation</a></li><li><a class="tocitem" href="../controls/">Emissions Controls</a></li><li><a class="tocitem" href="../elevpoint/">Elevated Source Identification</a></li><li><a class="tocitem" href="../laypoint/">Vertical Layer Allocation</a></li><li><a class="tocitem" href="../regridding/">Conservative Regridding</a></li><li><a class="tocitem" href="../biogenic/">Biogenic Emissions</a></li><li><a class="tocitem" href="../validation/">Inventory Validation</a></li><li><a class="tocitem" href="../orl/">ORL Format</a></li><li><a class="tocitem" href="../reporting/">QA Reporting</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Spatial Processing Pipeline</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Spatial Processing Pipeline</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/EarthSciML/Emissions.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/EarthSciML/Emissions.jl/blob/main/docs/src/spatial_processing.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Spatial-Processing-Pipeline"><a class="docs-heading-anchor" href="#Spatial-Processing-Pipeline">Spatial Processing Pipeline</a><a id="Spatial-Processing-Pipeline-1"></a><a class="docs-heading-anchor-permalink" href="#Spatial-Processing-Pipeline" title="Permalink"></a></h1><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>The Emissions.jl package provides a complete spatial processing pipeline for allocating emissions to grid cells, implementing the workflow from the <a href="https://github.com/EarthSciML/Emissions.jl/blob/main/examples/2019neiEmis_3.ipynb">2019 NEI emissions processing notebook</a>.</p><p>The pipeline consists of two layers:</p><ol><li><strong>Data Preparation</strong>: Reading FF10 files, aggregating emissions, filtering pollutants, mapping names, and assigning spatial surrogates.</li><li><strong>Spatial Allocation</strong>: Computing grid cell indices for emission locations, optionally refining with surrogate-weighted fractions, and distributing emissions to grid cells.</li></ol><h2 id="Data-Preparation-Functions"><a class="docs-heading-anchor" href="#Data-Preparation-Functions">Data Preparation Functions</a><a id="Data-Preparation-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Data-Preparation-Functions" title="Permalink"></a></h2><h3 id="File-I/O"><a class="docs-heading-anchor" href="#File-I/O">File I/O</a><a id="File-I/O-1"></a><a class="docs-heading-anchor-permalink" href="#File-I/O" title="Permalink"></a></h3><article><details class="docstring" open="true"><summary id="Emissions.read_ff10"><a class="docstring-binding" href="#Emissions.read_ff10"><code>Emissions.read_ff10</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">read_ff10(filepath::AbstractString, format::Symbol) -&gt; EmissionsDataFrame</code></pre><p>Read an FF10-format CSV file and return the appropriate <code>EmissionsDataFrame</code> subtype.</p><p><code>format</code> must be one of <code>:nonpoint</code>, <code>:point</code>, <code>:nonroad</code>, or <code>:onroad</code>.</p><p><strong>Examples</strong></p><pre><code class="language-julia hljs">emis = read_ff10(&quot;nonpoint_2019.csv&quot;, :nonpoint)
emis.df  # access the underlying DataFrame</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/pipeline.jl#L5-L17">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.normalize_country"><a class="docstring-binding" href="#Emissions.normalize_country"><code>Emissions.normalize_country</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">normalize_country(country::AbstractString) -&gt; String</code></pre><p>Normalize country codes to standard three-letter format. Maps &quot;US&quot; -&gt; &quot;USA&quot;, &quot;0&quot; -&gt; &quot;USA&quot;, &quot;1&quot; -&gt; &quot;Canada&quot;, &quot;2&quot; -&gt; &quot;Mexico&quot;. Already-standard codes are passed through unchanged.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/io.jl#L40-L46">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.read_gridref"><a class="docstring-binding" href="#Emissions.read_gridref"><code>Emissions.read_gridref</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">read_gridref(file_path::AbstractString) -&gt; DataFrame</code></pre><p>Read a SMOKE-format semicolon-delimited grid reference file. Lines starting with <code>#</code> are skipped. Each data line has the format: <code>FIPS;SCC;Surrogate!comment</code></p><p>Extracts COUNTRY from 6-digit FIPS codes and normalizes via <a href="#Emissions.normalize_country"><code>normalize_country</code></a>. Returns a DataFrame with columns: <code>[:COUNTRY, :FIPS, :SCC, :Surrogate]</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/io.jl#L60-L69">source</a></section></details></article><h3 id="Emissions-Processing"><a class="docs-heading-anchor" href="#Emissions-Processing">Emissions Processing</a><a id="Emissions-Processing-1"></a><a class="docs-heading-anchor-permalink" href="#Emissions-Processing" title="Permalink"></a></h3><article><details class="docstring" open="true"><summary id="Emissions.aggregate_emissions"><a class="docstring-binding" href="#Emissions.aggregate_emissions"><code>Emissions.aggregate_emissions</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">aggregate_emissions(dfs::Vector{DataFrame}) -&gt; DataFrame</code></pre><p>Concatenate multiple emission DataFrames, adding <code>LONGITUDE</code> and <code>LATITUDE</code> columns (as <code>missing</code>) for area sources that lack them, then group by <code>[:POLID, :COUNTRY, :FIPS, :SCC, :LONGITUDE, :LATITUDE]</code> and sum <code>ANN_VALUE</code>.</p><p>The result is sorted by <code>ANN_VALUE</code> descending.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/pipeline.jl#L63-L71">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.filter_known_pollutants"><a class="docstring-binding" href="#Emissions.filter_known_pollutants"><code>Emissions.filter_known_pollutants</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">filter_known_pollutants(df::DataFrame) -&gt; DataFrame</code></pre><p>Keep only rows where <code>POLID</code> is a key in the <a href="../nei_processing/#Emissions.Pollutants"><code>Pollutants</code></a> dictionary. Returns a filtered copy.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/pipeline.jl#L93-L98">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.map_pollutant_names!"><a class="docstring-binding" href="#Emissions.map_pollutant_names!"><code>Emissions.map_pollutant_names!</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">map_pollutant_names!(df::DataFrame) -&gt; DataFrame</code></pre><p>Map <code>POLID</code> values to standard pollutant group names using the <a href="../nei_processing/#Emissions.Pollutants"><code>Pollutants</code></a> dictionary (in-place). For example, &quot;EXH__VOC&quot; becomes &quot;VOC&quot; and &quot;PM25-PRI&quot; becomes &quot;PM25&quot;.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/pipeline.jl#L103-L108">source</a></section></details></article><h3 id="Surrogate-Assignment"><a class="docs-heading-anchor" href="#Surrogate-Assignment">Surrogate Assignment</a><a id="Surrogate-Assignment-1"></a><a class="docs-heading-anchor-permalink" href="#Surrogate-Assignment" title="Permalink"></a></h3><article><details class="docstring" open="true"><summary id="Emissions.assign_surrogates"><a class="docstring-binding" href="#Emissions.assign_surrogates"><code>Emissions.assign_surrogates</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">assign_surrogates(emissions::DataFrame, gridref::DataFrame) -&gt; DataFrame</code></pre><p>Assign spatial surrogates to emissions records by joining with grid reference data.</p><p>Performs a left join on <code>[:COUNTRY, :FIPS, :SCC]</code>. For rows that remain unmatched (no surrogate assigned), falls back to a state-level match by retrying the join with <code>FIPS=&quot;00000&quot;</code> in the grid reference, then restoring the original FIPS code.</p><p>Returns a copy of <code>emissions</code> with a <code>Surrogate</code> column added.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/pipeline.jl#L114-L124">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.build_data_weight_map"><a class="docstring-binding" href="#Emissions.build_data_weight_map"><code>Emissions.build_data_weight_map</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">build_data_weight_map(emissions::DataFrame, srgSpecs::Vector{SurrogateSpec}) -&gt; Dict{Tuple{String,String}, Vector{String}}</code></pre><p>Identify which surrogates are actually needed based on the emissions data, and build a mapping from <code>(data_shapefile, weight_shapefile)</code> pairs to lists of <code>&quot;Region+Code&quot;</code> strings.</p><p>This avoids loading shapefiles that aren&#39;t referenced by any emissions record.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/pipeline.jl#L156-L163">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.find_surrogate_by_code-Tuple{Vector{SurrogateSpec}, String, Int64}"><a class="docstring-binding" href="#Emissions.find_surrogate_by_code-Tuple{Vector{SurrogateSpec}, String, Int64}"><code>Emissions.find_surrogate_by_code</code></a> — <span class="docstring-category">Method</span></summary><section><div><pre><code class="language-julia hljs">find_surrogate_by_code(srgSpecs::Vector{SurrogateSpec}, region::String, code::Int)</code></pre><p>Find a surrogate specification by its region and code number. Backward-compatible method; prefer using the keyword argument version.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/output.jl#L39-L44">source</a></section></details></article><h2 id="Spatial-Allocation-Functions"><a class="docs-heading-anchor" href="#Spatial-Allocation-Functions">Spatial Allocation Functions</a><a id="Spatial-Allocation-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Spatial-Allocation-Functions" title="Permalink"></a></h2><h3 id="High-Level-Workflow-Functions"><a class="docs-heading-anchor" href="#High-Level-Workflow-Functions">High-Level Workflow Functions</a><a id="High-Level-Workflow-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#High-Level-Workflow-Functions" title="Permalink"></a></h3><article><details class="docstring" open="true"><summary id="Emissions.location_key"><a class="docstring-binding" href="#Emissions.location_key"><code>Emissions.location_key</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">location_key(fips::AbstractString, lon, lat) -&gt; String</code></pre><p>Compute a unique location key for an emissions record.</p><p>Point sources with valid coordinates return <code>&quot;FIPS_lon_lat&quot;</code>. Area sources (missing coordinates) return the FIPS code.</p><p>This key is used to look up pre-computed grid cell allocations in the location index dictionary returned by <a href="#Emissions.compute_grid_indices"><code>compute_grid_indices</code></a>.</p><p><strong>Examples</strong></p><pre><code class="language-julia-repl hljs">julia&gt; location_key(&quot;36001&quot;, -73.5, 40.5)
&quot;36001_-73.500000_40.500000&quot;

julia&gt; location_key(&quot;36001&quot;, missing, missing)
&quot;36001&quot;</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/workflow.jl#L6-L25">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.compute_grid_indices"><a class="docstring-binding" href="#Emissions.compute_grid_indices"><code>Emissions.compute_grid_indices</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">compute_grid_indices(emissions::DataFrame, grid::GridDef;
                     counties_shapefile::String=&quot;&quot;) -&gt; Dict{String, IndexInfo}</code></pre><p>Compute grid cell indices for all unique emission locations.</p><p>For each unique location in the emissions data:</p><ul><li><strong>Point sources</strong> (rows with non-missing <code>LONGITUDE</code> and <code>LATITUDE</code>): finds the grid cell containing the point using <a href="../nei_processing/#Emissions.GetIndex"><code>GetIndex</code></a>.</li><li><strong>Area sources</strong> (without coordinates): uses county polygon intersection with the grid if <code>counties_shapefile</code> is provided. The county polygon is looked up by FIPS code using <a href="../nei_processing/#Emissions.findCountyPolygon"><code>findCountyPolygon</code></a>.</li></ul><p>Returns a <code>Dict{String, IndexInfo}</code> mapping location keys (see <a href="#Emissions.location_key"><code>location_key</code></a>) to their grid cell allocations.</p><p><strong>Arguments</strong></p><ul><li><code>emissions::DataFrame</code>: Must have a <code>:FIPS</code> column. May have <code>:LONGITUDE</code> and <code>:LATITUDE</code>.</li><li><code>grid::GridDef</code>: Target grid definition.</li><li><code>counties_shapefile::String=&quot;&quot;</code>: Path to counties shapefile for area source indexing.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/workflow.jl#L33-L53">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.refine_indices_with_surrogates"><a class="docstring-binding" href="#Emissions.refine_indices_with_surrogates"><code>Emissions.refine_indices_with_surrogates</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">refine_indices_with_surrogates(locIndex::Dict{String, IndexInfo},
    county_surrogates::Dict{String, SparseMatrixCSC{Float64, Int}}) -&gt; Dict{String, IndexInfo}</code></pre><p>Refine area-source location indices using pre-computed county surrogate matrices.</p><p>For each FIPS-keyed entry in <code>locIndex</code> that has a matching entry in <code>county_surrogates</code>, replaces the area-based grid allocation with surrogate-weighted fractions via <a href="../nei_processing/#Emissions.update_locIndex"><code>update_locIndex</code></a>.</p><p>Point source entries (keys containing coordinates) are left unchanged, since point sources are allocated to their containing grid cell directly.</p><p><strong>Arguments</strong></p><ul><li><code>locIndex</code>: Location index dictionary from <a href="#Emissions.compute_grid_indices"><code>compute_grid_indices</code></a>.</li><li><code>county_surrogates</code>: Pre-computed surrogate matrices from <a href="../nei_processing/#Emissions.generate_countySurrogate"><code>generate_countySurrogate</code></a>, mapping FIPS codes to normalized allocation matrices.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/workflow.jl#L91-L109">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.allocate_emissions_to_grid"><a class="docstring-binding" href="#Emissions.allocate_emissions_to_grid"><code>Emissions.allocate_emissions_to_grid</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">allocate_emissions_to_grid(emissions::DataFrame,
    locIndex::Dict{String, IndexInfo}, grid::GridDef;
    pollutant_groups::Vector{String}=[&quot;VOC&quot;, &quot;NOX&quot;, &quot;NH3&quot;, &quot;SO2&quot;, &quot;PM25&quot;]) -&gt; DataFrame</code></pre><p>Distribute emissions records to grid cells using pre-computed location indices.</p><p>For each emissions record:</p><ol><li>Looks up the grid cell allocation from <code>locIndex</code> using <a href="#Emissions.location_key"><code>location_key</code></a></li><li>Distributes <code>ANN_VALUE</code> across grid cells according to fractional coverage</li><li>Accumulates results by <code>(cellIndex, SCC)</code> combination</li></ol><p><strong>Arguments</strong></p><ul><li><code>emissions::DataFrame</code>: Must have columns <code>:FIPS</code>, <code>:SCC</code>, <code>:POLID</code>, <code>:ANN_VALUE</code>. May have <code>:LONGITUDE</code> and <code>:LATITUDE</code> for point sources. <code>ANN_VALUE</code> may have Unitful units (they will be stripped).</li><li><code>locIndex</code>: Location index from <a href="#Emissions.compute_grid_indices"><code>compute_grid_indices</code></a> or <a href="#Emissions.refine_indices_with_surrogates"><code>refine_indices_with_surrogates</code></a>.</li><li><code>grid::GridDef</code>: Grid definition (used for cell index computation).</li><li><code>pollutant_groups</code>: Pollutant names to include in output columns.</li></ul><p><strong>Returns</strong></p><p>A <code>DataFrame</code> with columns: <code>cellIndex</code>, one column per pollutant group, and <code>SCC</code>. Each row represents accumulated emissions for a unique <code>(cellIndex, SCC)</code> combination, sorted by <code>cellIndex</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/workflow.jl#L123-L148">source</a></section></details></article><article><details class="docstring" open="true"><summary id="Emissions.process_emissions_spatial"><a class="docstring-binding" href="#Emissions.process_emissions_spatial"><code>Emissions.process_emissions_spatial</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">process_emissions_spatial(emissions::DataFrame, grid::GridDef;
    counties_shapefile::String=&quot;&quot;,
    county_surrogates::Dict{String, SparseMatrixCSC{Float64, Int}}=Dict{String, SparseMatrixCSC{Float64, Int}}(),
    pollutant_groups::Vector{String}=[&quot;VOC&quot;, &quot;NOX&quot;, &quot;NH3&quot;, &quot;SO2&quot;, &quot;PM25&quot;]) -&gt; DataFrame</code></pre><p>Execute the complete spatial processing workflow on prepared emissions data.</p><p>This function orchestrates the full spatial allocation pipeline:</p><ol><li>Compute grid cell indices for all unique locations (<a href="#Emissions.compute_grid_indices"><code>compute_grid_indices</code></a>)</li><li>Optionally refine area-source indices with surrogate data (<a href="#Emissions.refine_indices_with_surrogates"><code>refine_indices_with_surrogates</code></a>)</li><li>Allocate emissions to grid cells (<a href="#Emissions.allocate_emissions_to_grid"><code>allocate_emissions_to_grid</code></a>)</li></ol><p>The input <code>emissions</code> DataFrame should already be processed through the data preparation pipeline (<a href="#Emissions.filter_known_pollutants"><code>filter_known_pollutants</code></a>, <a href="#Emissions.map_pollutant_names!"><code>map_pollutant_names!</code></a>).</p><p><strong>Arguments</strong></p><ul><li><code>emissions::DataFrame</code>: Prepared emissions data with columns <code>:FIPS</code>, <code>:SCC</code>, <code>:POLID</code>, <code>:ANN_VALUE</code>. May have <code>:LONGITUDE</code>/<code>:LATITUDE</code> for point sources.</li><li><code>grid::GridDef</code>: Target grid definition.</li><li><code>counties_shapefile::String=&quot;&quot;</code>: Path to counties shapefile for area source indexing.</li><li><code>county_surrogates</code>: Pre-computed surrogate matrices for index refinement.</li><li><code>pollutant_groups</code>: Pollutant groups for output columns.</li></ul><p><strong>Returns</strong></p><p>A <code>DataFrame</code> with gridded emissions, one row per <code>(cellIndex, SCC)</code> combination.</p><p><strong>Example</strong></p><pre><code class="language-julia hljs">grid = NewGridIrregular(&quot;test&quot;, 3, 3, &quot;EPSG:4326&quot;, 1.0, 1.0, 0.0, 0.0)
emissions = DataFrame(
    FIPS=[&quot;00001&quot;, &quot;00001&quot;], POLID=[&quot;NOX&quot;, &quot;VOC&quot;],
    SCC=[&quot;2103007000&quot;, &quot;2103007000&quot;],
    ANN_VALUE=[1.0e-3, 5.0e-4],
    LONGITUDE=[0.5, 0.5], LATITUDE=[0.5, 0.5])
result = process_emissions_spatial(emissions, grid)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/Emissions.jl/blob/e7727cbd9e5c1ef27af0797d8afc153ae5840674/src/workflow.jl#L211-L248">source</a></section></details></article><h3 id="Low-Level-Surrogate-Generation-Functions"><a class="docs-heading-anchor" href="#Low-Level-Surrogate-Generation-Functions">Low-Level Surrogate Generation Functions</a><a id="Low-Level-Surrogate-Generation-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Low-Level-Surrogate-Generation-Functions" title="Permalink"></a></h3><p>The following low-level functions are used for advanced surrogate generation from shapefiles. For complete API documentation, see the <a href="../nei_processing/#surrogate-operations">NEI Processing</a> page.</p><ul><li><a href="../nei_processing/#Emissions.generate_data_sparse_matrices"><code>generate_data_sparse_matrices</code></a> - Generate sparse matrices from data shapefiles</li><li><a href="../nei_processing/#Emissions.generate_weight_sparse_matrices"><code>generate_weight_sparse_matrices</code></a> - Generate weight matrices from surrogate shapefiles</li><li><a href="../nei_processing/#Emissions.generate_grid_sparse_matrices"><code>generate_grid_sparse_matrices</code></a> - Generate grid area matrices</li><li><a href="../nei_processing/#Emissions.generate_countySurrogate"><code>generate_countySurrogate</code></a> - Combine data and weight matrices into normalized surrogates</li><li><a href="../nei_processing/#Emissions.update_locIndex"><code>update_locIndex</code></a> - Update location indices with surrogate data</li></ul><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><h3 id="Complete-Workflow-Example"><a class="docs-heading-anchor" href="#Complete-Workflow-Example">Complete Workflow Example</a><a id="Complete-Workflow-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Complete-Workflow-Example" title="Permalink"></a></h3><p>The following example demonstrates the full spatial processing pipeline using synthetic data. This corresponds to the workflow in the reference notebook.</p><pre><code class="language-julia hljs">using Emissions
using DataFrames
using SparseArrays

# =============================================================================
# Step 1: Create Synthetic Emissions Data
# =============================================================================
# Simulating two emission sectors with point source coordinates
nonpoint_data = DataFrame(
    POLID = [&quot;NOX&quot;, &quot;VOC&quot;, &quot;NOX&quot;, &quot;SO2&quot;],
    COUNTRY = [&quot;USA&quot;, &quot;USA&quot;, &quot;USA&quot;, &quot;USA&quot;],
    FIPS = [&quot;36001&quot;, &quot;36001&quot;, &quot;36005&quot;, &quot;36005&quot;],
    SCC = [&quot;2103007000&quot;, &quot;2103007000&quot;, &quot;2103007000&quot;, &quot;2103007000&quot;],
    ANN_VALUE = [150.5, 75.2, 200.1, 125.8]
)

onroad_data = DataFrame(
    POLID = [&quot;NOX&quot;, &quot;EXH__VOC&quot;, &quot;PM25-PRI&quot;],
    COUNTRY = [&quot;USA&quot;, &quot;USA&quot;, &quot;USA&quot;],
    FIPS = [&quot;36001&quot;, &quot;36001&quot;, &quot;36005&quot;],
    SCC = [&quot;2201001000&quot;, &quot;2201001000&quot;, &quot;2201001000&quot;],
    ANN_VALUE = [50.0, 30.0, 15.0]
)

println(&quot;Nonpoint records: &quot;, nrow(nonpoint_data))
println(&quot;Onroad records: &quot;, nrow(onroad_data))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Nonpoint records: 4
Onroad records: 3</code></pre><pre><code class="language-julia hljs"># =============================================================================
# Step 2: Aggregate Emissions from Multiple Sectors
# =============================================================================
combined = aggregate_emissions([nonpoint_data, onroad_data])
println(&quot;Combined records: &quot;, nrow(combined))
first(combined, 5)</code></pre><div><div style = "float: left;"><span>5×7 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">POLID</th><th style = "text-align: left;">COUNTRY</th><th style = "text-align: left;">FIPS</th><th style = "text-align: left;">SCC</th><th style = "text-align: left;">LONGITUDE</th><th style = "text-align: left;">LATITUDE</th><th style = "text-align: left;">ANN_VALUE</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th><th title = "Missing" style = "text-align: left;">Missing</th><th title = "Missing" style = "text-align: left;">Missing</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">NOX</td><td style = "text-align: left;">USA</td><td style = "text-align: left;">36005</td><td style = "text-align: left;">2103007000</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "text-align: right;">200.1</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">NOX</td><td style = "text-align: left;">USA</td><td style = "text-align: left;">36001</td><td style = "text-align: left;">2103007000</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "text-align: right;">150.5</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">SO2</td><td style = "text-align: left;">USA</td><td style = "text-align: left;">36005</td><td style = "text-align: left;">2103007000</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "text-align: right;">125.8</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">VOC</td><td style = "text-align: left;">USA</td><td style = "text-align: left;">36001</td><td style = "text-align: left;">2103007000</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "text-align: right;">75.2</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">NOX</td><td style = "text-align: left;">USA</td><td style = "text-align: left;">36001</td><td style = "text-align: left;">2201001000</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "text-align: right;">50.0</td></tr></tbody></table></div><pre><code class="language-julia hljs"># =============================================================================
# Step 3: Filter to Known Pollutants and Map Names
# =============================================================================
filtered = filter_known_pollutants(combined)
println(&quot;After filtering: &quot;, nrow(filtered))

map_pollutant_names!(filtered)
println(&quot;Unique pollutants: &quot;, unique(filtered.POLID))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">After filtering: 7
Unique pollutants: [&quot;NOX&quot;, &quot;SO2&quot;, &quot;VOC&quot;, &quot;PM25&quot;]</code></pre><pre><code class="language-julia hljs"># =============================================================================
# Step 4: Assign Spatial Surrogates
# =============================================================================
gridref = DataFrame(
    COUNTRY = [&quot;USA&quot;, &quot;USA&quot;, &quot;USA&quot;],
    FIPS = [&quot;36001&quot;, &quot;36005&quot;, &quot;00000&quot;],
    SCC = [&quot;2103007000&quot;, &quot;2103007000&quot;, &quot;2201001000&quot;],
    Surrogate = [100, 100, 200]
)

with_surrogates = assign_surrogates(filtered, gridref)
println(&quot;Surrogates assigned: &quot;, count(!ismissing, with_surrogates.Surrogate),
    &quot; of &quot;, nrow(with_surrogates))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Surrogates assigned: 7 of 7</code></pre><pre><code class="language-julia hljs"># =============================================================================
# Step 5: Create Target Grid
# =============================================================================
# Create a simple 4x4 grid (in real use, this would be an InMAP or CMAQ grid)
grid = NewGridIrregular(&quot;CONUS_4x4&quot;, 4, 4, &quot;EPSG:4326&quot;, 1.0, 1.0, -76.0, 39.0)
println(&quot;Grid: $(grid.Nx) x $(grid.Ny) = $(grid.Nx * grid.Ny) cells&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Grid: 4 x 4 = 16 cells</code></pre><pre><code class="language-julia hljs"># =============================================================================
# Step 6: Spatial Allocation with Surrogates
# =============================================================================
# Create synthetic county surrogates that distribute emissions across grid cells.
# In real use, these are generated by generate_data_sparse_matrices(),
# generate_weight_sparse_matrices(), and generate_countySurrogate().

# County 36001 (Albany, NY): 60% in cell (1,1), 40% in cell (1,2)
srg_36001 = sparse([1, 1], [1, 2], [0.6, 0.4], 4, 4)

# County 36005 (Bronx, NY): 50% in cell (2,1), 30% in cell (2,2), 20% in cell (3,1)
srg_36005 = sparse([2, 2, 3], [1, 2, 1], [0.5, 0.3, 0.2], 4, 4)

county_surrogates = Dict(&quot;36001&quot; =&gt; srg_36001, &quot;36005&quot; =&gt; srg_36005)

# Run the complete spatial allocation workflow
gridded = process_emissions_spatial(with_surrogates, grid;
    county_surrogates=county_surrogates)

println(&quot;Gridded output: $(nrow(gridded)) rows&quot;)
gridded</code></pre><div><div style = "float: left;"><span>10×7 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">cellIndex</th><th style = "text-align: left;">SCC</th><th style = "text-align: left;">VOC</th><th style = "text-align: left;">NOX</th><th style = "text-align: left;">NH3</th><th style = "text-align: left;">SO2</th><th style = "text-align: left;">PM25</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "String" style = "text-align: left;">String</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">1</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">45.12</td><td style = "text-align: right;">90.3</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">1</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">18.0</td><td style = "text-align: right;">30.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">2</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">30.08</td><td style = "text-align: right;">60.2</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">2</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">12.0</td><td style = "text-align: right;">20.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">5</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">100.05</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">62.9</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: right;">5</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">7.5</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: right;">6</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">60.03</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">37.74</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">8</td><td style = "text-align: right;">6</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">4.5</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">9</td><td style = "text-align: right;">9</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">40.02</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">25.16</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">10</td><td style = "text-align: right;">9</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">3.0</td></tr></tbody></table></div><h3 id="Step-by-Step-Spatial-Allocation"><a class="docs-heading-anchor" href="#Step-by-Step-Spatial-Allocation">Step-by-Step Spatial Allocation</a><a id="Step-by-Step-Spatial-Allocation-1"></a><a class="docs-heading-anchor-permalink" href="#Step-by-Step-Spatial-Allocation" title="Permalink"></a></h3><p>The <code>process_emissions_spatial</code> function orchestrates three steps that can also be called individually for more control:</p><pre><code class="language-julia hljs"># Step 6a: Compute grid indices for all unique locations
locIndex = compute_grid_indices(with_surrogates, grid)
println(&quot;Location indices computed: &quot;, length(locIndex))
for (key, idx) in locIndex
    println(&quot;  $key: inGrid=$(idx.inGrid), cells=$(length(idx.rows))&quot;)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Location indices computed: 2
  36001: inGrid=false, cells=0
  36005: inGrid=false, cells=0</code></pre><pre><code class="language-julia hljs"># Step 6b: Refine area-source indices with surrogate data
refine_indices_with_surrogates(locIndex, county_surrogates)
println(&quot;\nAfter surrogate refinement:&quot;)
for (key, idx) in locIndex
    println(&quot;  $key: inGrid=$(idx.inGrid), cells=$(length(idx.rows))&quot;)
    if idx.inGrid
        for k in eachindex(idx.rows)
            println(&quot;    cell($(idx.rows[k]),$(idx.cols[k])): $(round(idx.fracs[k]*100, digits=1))%&quot;)
        end
    end
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">
After surrogate refinement:
  36001: inGrid=true, cells=2
    cell(1,1): 60.0%
    cell(1,2): 40.0%
  36005: inGrid=true, cells=3
    cell(2,1): 50.0%
    cell(3,1): 20.0%
    cell(2,2): 30.0%</code></pre><pre><code class="language-julia hljs"># Step 6c: Allocate emissions to grid cells
gridded_manual = allocate_emissions_to_grid(with_surrogates, locIndex, grid)
println(&quot;Manual allocation result: $(nrow(gridded_manual)) rows&quot;)
gridded_manual</code></pre><div><div style = "float: left;"><span>10×7 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">cellIndex</th><th style = "text-align: left;">SCC</th><th style = "text-align: left;">VOC</th><th style = "text-align: left;">NOX</th><th style = "text-align: left;">NH3</th><th style = "text-align: left;">SO2</th><th style = "text-align: left;">PM25</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "String" style = "text-align: left;">String</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">1</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">45.12</td><td style = "text-align: right;">90.3</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">1</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">18.0</td><td style = "text-align: right;">30.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">2</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">30.08</td><td style = "text-align: right;">60.2</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">2</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">12.0</td><td style = "text-align: right;">20.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">5</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">100.05</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">62.9</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: right;">5</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">7.5</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: right;">6</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">60.03</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">37.74</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">8</td><td style = "text-align: right;">6</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">4.5</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">9</td><td style = "text-align: right;">9</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">40.02</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">25.16</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">10</td><td style = "text-align: right;">9</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">3.0</td></tr></tbody></table></div><h3 id="Point-Source-Processing"><a class="docs-heading-anchor" href="#Point-Source-Processing">Point Source Processing</a><a id="Point-Source-Processing-1"></a><a class="docs-heading-anchor-permalink" href="#Point-Source-Processing" title="Permalink"></a></h3><p>Point sources with coordinates are allocated directly to their containing grid cell:</p><pre><code class="language-julia hljs"># Point source emissions with explicit coordinates
point_emissions = DataFrame(
    FIPS = [&quot;36001&quot;, &quot;36001&quot;],
    POLID = [&quot;NOX&quot;, &quot;VOC&quot;],
    SCC = [&quot;2103007000&quot;, &quot;2103007000&quot;],
    ANN_VALUE = [1.0e-3, 5.0e-4],
    LONGITUDE = [-75.5, -75.5],
    LATITUDE = [39.5, 39.5]
)

point_result = process_emissions_spatial(point_emissions, grid)
println(&quot;Point source allocation:&quot;)
point_result</code></pre><div><div style = "float: left;"><span>1×7 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">cellIndex</th><th style = "text-align: left;">SCC</th><th style = "text-align: left;">VOC</th><th style = "text-align: left;">NOX</th><th style = "text-align: left;">NH3</th><th style = "text-align: left;">SO2</th><th style = "text-align: left;">PM25</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "String" style = "text-align: left;">String</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">1</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0005</td><td style = "text-align: right;">0.001</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr></tbody></table></div><h2 id="Analysis"><a class="docs-heading-anchor" href="#Analysis">Analysis</a><a id="Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Analysis" title="Permalink"></a></h2><h3 id="Surrogate-Assignment-with-Fallback"><a class="docs-heading-anchor" href="#Surrogate-Assignment-with-Fallback">Surrogate Assignment with Fallback</a><a id="Surrogate-Assignment-with-Fallback-1"></a><a class="docs-heading-anchor-permalink" href="#Surrogate-Assignment-with-Fallback" title="Permalink"></a></h3><p>The <code>assign_surrogates</code> function implements a two-pass matching strategy:</p><ol><li><strong>Direct match</strong>: Joins emissions with grid reference on <code>(COUNTRY, FIPS, SCC)</code></li><li><strong>Fallback match</strong>: For unmatched records, retries with <code>FIPS=&quot;00000&quot;</code> (state-level default)</li></ol><p>This ensures that emissions records always get a surrogate assignment when a default is available, even if the specific county-level entry is missing from the grid reference.</p><pre><code class="language-julia hljs"># Demonstrate fallback: FIPS 36999 is not in gridref, but &quot;00000&quot; provides a default
test_emissions = DataFrame(
    POLID = [&quot;NOX&quot;, &quot;NOX&quot;],
    COUNTRY = [&quot;USA&quot;, &quot;USA&quot;],
    FIPS = [&quot;36001&quot;, &quot;36999&quot;],
    SCC = [&quot;2103007000&quot;, &quot;2103007000&quot;],
    ANN_VALUE = [100.0, 50.0]
)
test_gridref = DataFrame(
    COUNTRY = [&quot;USA&quot;, &quot;USA&quot;],
    FIPS = [&quot;36001&quot;, &quot;00000&quot;],
    SCC = [&quot;2103007000&quot;, &quot;2103007000&quot;],
    Surrogate = [100, 300]
)
result = assign_surrogates(test_emissions, test_gridref)
println(&quot;FIPS 36001 surrogate: &quot;, result[result.FIPS .== &quot;36001&quot;, :Surrogate][1])
println(&quot;FIPS 36999 surrogate (fallback): &quot;, result[result.FIPS .== &quot;36999&quot;, :Surrogate][1])
println(&quot;FIPS 36999 preserved: &quot;, result[result.FIPS .== &quot;36999&quot;, :FIPS][1])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">FIPS 36001 surrogate: 100
FIPS 36999 surrogate (fallback): 300
FIPS 36999 preserved: 36999</code></pre><h3 id="Emissions-Conservation"><a class="docs-heading-anchor" href="#Emissions-Conservation">Emissions Conservation</a><a id="Emissions-Conservation-1"></a><a class="docs-heading-anchor-permalink" href="#Emissions-Conservation" title="Permalink"></a></h3><p>A key property of the spatial allocation is that total emissions are conserved. The surrogate fractions are normalized to sum to 1.0 for each county, ensuring that distributing emissions across grid cells preserves the total:</p><pre><code class="language-julia hljs"># Verify conservation: total emissions in == total emissions out
input_nox = sum(filter(r -&gt; r.POLID == &quot;NOX&quot;, with_surrogates).ANN_VALUE)
output_nox = sum(gridded.NOX)
println(&quot;Input NOX total:  &quot;, round(input_nox, digits=4))
println(&quot;Output NOX total: &quot;, round(output_nox, digits=4))
println(&quot;Conservation: &quot;, isapprox(input_nox, output_nox, rtol=1e-10) ? &quot;PASS&quot; : &quot;FAIL&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Input NOX total:  400.6
Output NOX total: 400.6
Conservation: PASS</code></pre><h3 id="Country-Code-Normalization"><a class="docs-heading-anchor" href="#Country-Code-Normalization">Country Code Normalization</a><a id="Country-Code-Normalization-1"></a><a class="docs-heading-anchor-permalink" href="#Country-Code-Normalization" title="Permalink"></a></h3><p>The <code>normalize_country</code> function handles the various country code formats found in different data sources:</p><pre><code class="language-julia hljs">codes = [&quot;US&quot;, &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;USA&quot;, &quot;Canada&quot;]
for code in codes
    println(&quot;\&quot;$code\&quot; =&gt; \&quot;$(normalize_country(code))\&quot;&quot;)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;US&quot; =&gt; &quot;USA&quot;
&quot;0&quot; =&gt; &quot;USA&quot;
&quot;1&quot; =&gt; &quot;Canada&quot;
&quot;2&quot; =&gt; &quot;Mexico&quot;
&quot;USA&quot; =&gt; &quot;USA&quot;
&quot;Canada&quot; =&gt; &quot;Canada&quot;</code></pre><h3 id="Advanced-Surrogate-Generation"><a class="docs-heading-anchor" href="#Advanced-Surrogate-Generation">Advanced Surrogate Generation</a><a id="Advanced-Surrogate-Generation-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-Surrogate-Generation" title="Permalink"></a></h3><p>For more complex spatial allocation scenarios, you can generate surrogate matrices directly from shapefiles using the low-level surrogate generation functions. This example demonstrates how to create county surrogates from census and employment data:</p><pre><code class="language-julia hljs"># =============================================================================
# Step 7: Advanced Surrogate Generation from Shapefiles
# =============================================================================
# This demonstrates the workflow for generating surrogates when you have
# county polygons and weight data (e.g., population, employment) shapefiles

println(&quot;Advanced surrogate generation workflow:&quot;)
println(&quot;1. Generate county polygon matrices using:&quot;)
println(&quot;   data_matrices = generate_data_sparse_matrices(&quot;)
println(&quot;       \&quot;counties.shp\&quot;, \&quot;FIPS\&quot;, grid, \&quot;EPSG:4326\&quot;)&quot;)
println()
println(&quot;2. Generate weight matrices (e.g., from census blocks) using:&quot;)
println(&quot;   weight_matrix = generate_weight_sparse_matrices(&quot;)
println(&quot;       \&quot;census_blocks.shp\&quot;, [\&quot;POPULATION\&quot;], [1.0], grid, \&quot;EPSG:4326\&quot;)&quot;)
println()
println(&quot;3. Generate grid matrices for normalization using:&quot;)
println(&quot;   grid_matrix = generate_grid_sparse_matrices(grid)&quot;)
println()
println(&quot;4. Combine into county-level surrogates using:&quot;)
println(&quot;   county_surrogates = generate_countySurrogate(&quot;)
println(&quot;       data_matrices, weight_matrix, grid_matrix)&quot;)
println()

# For demonstration, we&#39;ll show the expected data structure:
println(&quot;Example surrogate matrix structure:&quot;)
example_matrix = sparse([1, 1, 2], [1, 2, 1], [0.6, 0.4, 1.0], 4, 4)
println(&quot;Matrix dimensions: &quot;, size(example_matrix))
println(&quot;Non-zero entries: &quot;, nnz(example_matrix))
println(&quot;Row sums: &quot;, [sum(example_matrix[i, :]) for i in 1:size(example_matrix, 1)])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Advanced surrogate generation workflow:
1. Generate county polygon matrices using:
   data_matrices = generate_data_sparse_matrices(
       &quot;counties.shp&quot;, &quot;FIPS&quot;, grid, &quot;EPSG:4326&quot;)

2. Generate weight matrices (e.g., from census blocks) using:
   weight_matrix = generate_weight_sparse_matrices(
       &quot;census_blocks.shp&quot;, [&quot;POPULATION&quot;], [1.0], grid, &quot;EPSG:4326&quot;)

3. Generate grid matrices for normalization using:
   grid_matrix = generate_grid_sparse_matrices(grid)

4. Combine into county-level surrogates using:
   county_surrogates = generate_countySurrogate(
       data_matrices, weight_matrix, grid_matrix)

Example surrogate matrix structure:
Matrix dimensions: (4, 4)
Non-zero entries: 3
Row sums: [1.0, 1.0, 0.0, 0.0]</code></pre><pre><code class="language-julia hljs"># =============================================================================
# Step 8: Complete End-to-End Workflow with Manual Surrogate Creation
# =============================================================================
# This demonstrates creating surrogates programmatically without shapefiles
# (useful for testing and when actual shapefile data is not available)

println(&quot;Creating synthetic surrogate data for complete workflow demonstration:&quot;)

# Simulate data matrices (county polygons)
# In real use, these come from generate_data_sparse_matrices()
println(&quot;1. Simulating data matrices (county coverage):&quot;)
data_matrices = Dict{String, SparseMatrixCSC{Float64,Int}}()
data_matrices[&quot;36001&quot;] = sparse([1, 1, 2], [1, 2, 2], [0.8, 0.3, 0.5], 4, 4)  # Albany county
data_matrices[&quot;36005&quot;] = sparse([2, 3, 3], [1, 1, 2], [0.7, 0.4, 0.6], 4, 4)  # Bronx county
println(&quot;   County 36001 covers &quot;, nnz(data_matrices[&quot;36001&quot;]), &quot; grid cells&quot;)
println(&quot;   County 36005 covers &quot;, nnz(data_matrices[&quot;36005&quot;]), &quot; grid cells&quot;)

# Simulate weight matrix (population distribution)
# In real use, this comes from generate_weight_sparse_matrices()
println(&quot;\n2. Simulating weight matrix (population distribution):&quot;)
weight_matrix = sparse([1, 1, 2, 2, 3, 3], [1, 2, 1, 2, 1, 2],
                      [1000.0, 800.0, 1500.0, 1200.0, 600.0, 900.0], 4, 4)
println(&quot;   Population weight matrix has &quot;, nnz(weight_matrix), &quot; populated cells&quot;)

# Generate grid matrix
# In real use, this comes from generate_grid_sparse_matrices()
println(&quot;\n3. Generating grid matrix (cell areas):&quot;)
grid_matrix = generate_grid_sparse_matrices(grid)
println(&quot;   Grid matrix covers &quot;, nnz(grid_matrix), &quot; cells&quot;)

# Generate county surrogates using the implemented function
println(&quot;\n4. Generating county surrogates:&quot;)
county_surrogates_full = generate_countySurrogate(data_matrices, weight_matrix, grid_matrix)
println(&quot;   Generated surrogates for &quot;, length(county_surrogates_full), &quot; counties&quot;)

for (county, surrogate) in county_surrogates_full
    total = sum(surrogate)
    println(&quot;   County $county: $(nnz(surrogate)) cells, total weight = $(round(total, digits=6))&quot;)
end

# Now use these surrogates in the workflow
println(&quot;\n5. Running spatial allocation with generated surrogates:&quot;)
final_result = process_emissions_spatial(with_surrogates, grid;
    county_surrogates=county_surrogates_full)

println(&quot;Final gridded emissions:&quot;)
final_result</code></pre><div><div style = "float: left;"><span>12×7 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">cellIndex</th><th style = "text-align: left;">SCC</th><th style = "text-align: left;">VOC</th><th style = "text-align: left;">NOX</th><th style = "text-align: left;">NH3</th><th style = "text-align: left;">SO2</th><th style = "text-align: left;">PM25</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "String" style = "text-align: left;">String</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">1</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">14.6341</td><td style = "text-align: right;">24.3902</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">1</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">36.6829</td><td style = "text-align: right;">73.4146</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">2</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">11.0049</td><td style = "text-align: right;">22.0244</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">2</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">4.39024</td><td style = "text-align: right;">7.31707</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">5</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">114.811</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">72.1803</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: right;">5</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">8.60656</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: right;">6</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">10.9756</td><td style = "text-align: right;">18.2927</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">8</td><td style = "text-align: right;">6</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">27.5122</td><td style = "text-align: right;">55.061</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">9</td><td style = "text-align: right;">9</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">1.96721</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">10</td><td style = "text-align: right;">9</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">26.2426</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">16.4984</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">11</td><td style = "text-align: right;">10</td><td style = "text-align: left;">2103007000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">59.0459</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">37.1213</td><td style = "text-align: right;">0.0</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">12</td><td style = "text-align: right;">10</td><td style = "text-align: left;">2201001000</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">4.42623</td></tr></tbody></table></div><h2 id="Relationship-to-Reference-Workflow"><a class="docs-heading-anchor" href="#Relationship-to-Reference-Workflow">Relationship to Reference Workflow</a><a id="Relationship-to-Reference-Workflow-1"></a><a class="docs-heading-anchor-permalink" href="#Relationship-to-Reference-Workflow" title="Permalink"></a></h2><p>These functions implement the complete emissions spatial processing workflow from the <a href="https://github.com/EarthSciML/Emissions.jl/blob/main/examples/2019neiEmis_3.ipynb">2019 NEI emissions notebook</a>.</p><table><tr><th style="text-align: left">Notebook Step</th><th style="text-align: left">Function</th><th style="text-align: left">Notes</th></tr><tr><td style="text-align: left">Read FF10 files</td><td style="text-align: left"><a href="#Emissions.read_ff10"><code>read_ff10</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Concatenate and aggregate</td><td style="text-align: left"><a href="#Emissions.aggregate_emissions"><code>aggregate_emissions</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Filter pollutants</td><td style="text-align: left"><a href="#Emissions.filter_known_pollutants"><code>filter_known_pollutants</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Map pollutant names</td><td style="text-align: left"><a href="#Emissions.map_pollutant_names!"><code>map_pollutant_names!</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Assign surrogates via grid ref</td><td style="text-align: left"><a href="#Emissions.assign_surrogates"><code>assign_surrogates</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Build shapefile map</td><td style="text-align: left"><a href="#Emissions.build_data_weight_map"><code>build_data_weight_map</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Compute grid indices</td><td style="text-align: left"><a href="#Emissions.compute_grid_indices"><code>compute_grid_indices</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Generate sparse matrices</td><td style="text-align: left"><a href="../nei_processing/#Emissions.generate_data_sparse_matrices"><code>generate_data_sparse_matrices</code></a>, <a href="../nei_processing/#Emissions.generate_weight_sparse_matrices"><code>generate_weight_sparse_matrices</code></a>, <a href="../nei_processing/#Emissions.generate_grid_sparse_matrices"><code>generate_grid_sparse_matrices</code></a></td><td style="text-align: left">✓ Complete (uses GridDef instead of explicit bounds)</td></tr><tr><td style="text-align: left">Compute county surrogates</td><td style="text-align: left"><a href="../nei_processing/#Emissions.generate_countySurrogate"><code>generate_countySurrogate</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Refine with surrogates</td><td style="text-align: left"><a href="#Emissions.refine_indices_with_surrogates"><code>refine_indices_with_surrogates</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Allocate to grid</td><td style="text-align: left"><a href="#Emissions.allocate_emissions_to_grid"><code>allocate_emissions_to_grid</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Complete workflow</td><td style="text-align: left"><a href="#Emissions.process_emissions_spatial"><code>process_emissions_spatial</code></a></td><td style="text-align: left">✓ Complete</td></tr><tr><td style="text-align: left">Write output</td><td style="text-align: left"><a href="../nei_processing/#Emissions.writeEmis"><code>writeEmis</code></a></td><td style="text-align: left">⚠ Simplified API, outputs DataFrame instead of shapefile</td></tr></table><p><strong>Notes on Implementation Differences:</strong></p><ul><li><strong>Sparse matrix functions</strong>: The implementation uses <code>GridDef</code> objects instead of explicit bounds/resolution parameters for better type safety and consistency with the rest of the package.</li><li><strong>Weight matrix generation</strong>: The implementation accepts pre-processed weight columns and factors instead of dynamic filter functions, providing a more predictable API.</li><li><strong>Output format</strong>: The <code>writeEmis</code> function outputs structured DataFrames suitable for further processing, rather than directly writing shapefiles.</li></ul><p>These differences make the implementation more composable and testable while maintaining full compatibility with the workflow described in the reference notebook. The core spatial processing workflow is complete and functional.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../nei_processing/">« NEI Processing</a><a class="docs-footer-nextpage" href="../temporal_processing/">Temporal Processing »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Wednesday 18 February 2026 02:28">Wednesday 18 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
